# AcneAI Backend API Documentation

## ğŸ“‹ Table of Contents
1. [Overview](#overview)
2. [Base Configuration](#base-configuration)
3. [Authentication Endpoints](#authentication-endpoints)
4. [User Information Endpoints](#user-information-endpoints)
5. [Acne Analysis Endpoints](#acne-analysis-endpoints)
6. [Treatment Plan Endpoints](#treatment-plan-endpoints)
7. [Request/Response Format](#requestresponse-format)
8. [Error Codes](#error-codes)
9. [Authentication & Security](#authentication--security)
10. [Project Flow Diagram](#project-flow-diagram)

---

## Overview

**AcneAI** is a dermatology-powered REST API that provides:
- User authentication and registration with OTP verification
- AI-powered acne severity analysis using ML models
- Personalized treatment plans generated by GROQ AI
- Daily treatment reviews and adaptive recommendations
- Full CORS support for React Vite frontend applications

**Tech Stack:**
- Runtime: Node.js with Express.js
- Database: MongoDB
- Authentication: JWT
- ML Integration: Hugging Face API
- AI Model: GROQ LLaMA 3.1 (dermatology-specialized)
- Email Service: Nodemailer (Gmail SMTP)
- File Uploads: Multer

---

## Base Configuration

### Base URL
```
http://localhost:5000/api
```

### CORS Configuration
The API is configured to accept requests **ONLY** from whitelisted origins:

```
ALLOWED_ORIGINS=http://localhost:5173
```

**Note:** React Vite's default development port is `5173`. Update `ALLOWED_ORIGINS` in `.env` for production deployment.

### Environment Variables Required
```env
# Database
MONGO_URI=mongodb://localhost:27017/acnedb

# Authentication
JWT_SECRET=your_secret_key_here

# AI Services
ML_API_URL=https://your-ml-service/predict
GROQ_API_KEY=your_groq_api_key

# Email Service
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your_email@gmail.com
SMTP_PASS=your_app_password
SMTP_FROM="AcneAI <no-reply@example.com>"

# CORS
ALLOWED_ORIGINS=http://localhost:5173
```

### Rate Limiting
- **Auth Endpoints:** 50 requests per 15 minutes
- **General API:** 100 requests per 15 minutes
- **GET requests:** Exempt from auth rate limiting

---

## Authentication Endpoints

### 1. User Registration
**Endpoint:** `POST /auth/register`

**Rate Limit:** 50 requests per 15 minutes

**Description:** Register a new user account. An OTP will be sent to the provided email for verification.

**Request Body:**
```json
{
  "username": "john_doe",
  "email": "john@example.com",
  "password": "SecurePass123!",
  "retype_password": "SecurePass123!"
}
```

**Validation Rules:**
- Username: Required, alphanumeric
- Email: Required, valid email format
- Password: Minimum 8 characters
- Password confirmation: Must match password field

**Success Response (200):**
```json
{
  "message": "OTP sent to email"
}
```

**Error Responses:**

| Status | Message | Description |
|--------|---------|-------------|
| 400 | "All fields are required" | Missing required fields |
| 400 | "Passwords do not match" | Password fields don't match |
| 400 | "Password too short" | Password less than 8 characters |
| 409 | "Email or username already registered" | Verified account exists |
| 409 | "Account exists but not verified. Use resend OTP to verify." | Unverified account exists |
| 500 | "Registration failed" | Server error |

---

### 2. Verify OTP
**Endpoint:** `POST /auth/verify-otp`

**Rate Limit:** 50 requests per 15 minutes

**Description:** Verify the OTP sent to user's email during registration.

**Request Body:**
```json
{
  "email": "john@example.com",
  "otp": "123456"
}
```

**OTP Details:**
- Valid for: 5 minutes
- Format: 6-digit numeric code
- Sent via: Email

**Success Response (200):**
```json
{
  "message": "Account verified"
}
```

**Error Responses:**

| Status | Message | Description |
|--------|---------|-------------|
| 400 | "Email and OTP required" | Missing fields |
| 400 | "Invalid OTP" | Wrong OTP or user not found |
| 400 | "OTP expired" | OTP validity period exceeded |
| 500 | "Verification failed" | Server error |

**After Verification:**
- Account is activated
- User can now login
- Welcome email is sent

---

### 3. Resend OTP
**Endpoint:** `POST /auth/resend-otp`

**Rate Limit:** 50 requests per 15 minutes

**Description:** Resend OTP to unverified accounts.

**Request Body:**
```json
{
  "email": "john@example.com"
}
```

**Success Response (200):**
```json
{
  "message": "If account exists, OTP resent"
}
```

**Error Responses:**

| Status | Message | Description |
|--------|---------|-------------|
| 400 | "Email required" | Email field missing |
| 400 | "OTP still valid" | Current OTP hasn't expired |
| 409 | "Account already verified" | Account already activated |
| 200 | "If account exists, OTP resent" | Generic response (no account exposure) |
| 500 | "Resend failed" | Server error |

---

### 4. User Login
**Endpoint:** `POST /auth/login`

**Rate Limit:** 50 requests per 15 minutes

**Description:** Authenticate user and receive JWT token.

**Request Body:**
```json
{
  "email": "john@example.com",
  "password": "SecurePass123!"
}
```

**Success Response (200):**
```json
{
  "message": "Login successful",
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "userId": "USR-550e8400-e29b-41d4-a716-446655440000",
    "username": "john_doe",
    "email": "john@example.com"
  }
}
```

**Token Details:**
- Type: JWT (JSON Web Token)
- Expires: 7 days
- Use in headers: `Authorization: Bearer <token>`

**Error Responses:**

| Status | Message | Description |
|--------|---------|-------------|
| 400 | "Email and password required" | Missing fields |
| 401 | "Invalid credentials" | Wrong email or password |
| 403 | "Account not verified" | OTP verification pending |
| 500 | "Login failed" | Server error |

---

### 5. Forgot Password
**Endpoint:** `POST /auth/forgot-password`

**Rate Limit:** 50 requests per 15 minutes

**Description:** Request password reset link.

**Request Body:**
```json
{
  "email": "john@example.com"
}
```

**Success Response (200):**
```json
{
  "message": "Password reset email sent"
}
```

**Details:**
- Reset link sent via email
- Link valid for: 15 minutes
- No link shown if account doesn't exist (security)

---

### 6. Reset Password
**Endpoint:** `POST /auth/reset-password`

**Rate Limit:** 50 requests per 15 minutes

**Description:** Complete password reset with token.

**Request Body:**
```json
{
  "email": "john@example.com",
  "reset_token": "token_from_email",
  "new_password": "NewPass123!",
  "confirm_password": "NewPass123!"
}
```

**Validation:**
- Passwords must match
- Minimum 8 characters
- Token must be valid and not expired

**Success Response (200):**
```json
{
  "message": "Password reset successful"
}
```

**Error Responses:**

| Status | Message | Description |
|--------|---------|-------------|
| 400 | "All fields required" | Missing fields |
| 400 | "Passwords do not match" | Confirmation mismatch |
| 400 | "Password too short" | Less than 8 characters |
| 400 | "Invalid or expired reset token" | Token invalid/expired |
| 500 | "Password reset failed" | Server error |

---

### 7. Get User Count
**Endpoint:** `GET /auth/users/count`

**Rate Limit:** None (GET request exempted)

**Description:** Get total verified users count (public endpoint).

**Success Response (200):**
```json
{
  "count": 1245
}
```

---

## User Information Endpoints

### 1. Save User Questionnaire
**Endpoint:** `POST /auth/userinfo`

**Authentication:** Required (JWT Token)

**Description:** Save user health questionnaire responses. Each user can submit only once.

**Request Body:**
```json
{
  "ageGroup": "18-25",
  "sex": "Male",
  "skinType": "Oily",
  "acneDuration": "2-3 years",
  "acneLocation": ["forehead", "cheeks", "chin"],
  "sensitiveSkin": "Yes",
  "medicationAllergy": "Yes",
  "allergyReactionTypes": ["itching", "redness"],
  "acneMedicationReaction": ["dryness", "redness"],
  "usingAcneProducts": "Yes",
  "currentProducts": ["Salicylic acid wash", "Benzoyl peroxide"],
  "stressLevel": "High",
  "sleepHours": "6-8",
  "dairyConsumption": "Regular"
}
```

**Field Descriptions:**

| Field | Type | Required | Example |
|-------|------|----------|---------|
| ageGroup | String | Yes | "18-25", "25-35", "35-45", "45+" |
| sex | String | Yes | "Male", "Female", "Other" |
| skinType | String | Yes | "Oily", "Dry", "Combination", "Normal" |
| acneDuration | String | Yes | "Less than 1 year", "1-2 years", "2-3 years", "3+ years" |
| acneLocation | String[] | Yes | ["forehead", "cheeks", "chin", "neck", "back", "shoulders"] |
| sensitiveSkin | String | Yes | "Yes", "No" |
| medicationAllergy | String | Yes | "Yes", "No" |
| allergyReactionTypes | String[] | If medicationAllergy="Yes" | ["itching", "redness", "swelling", "burning"] |
| acneMedicationReaction | String[] | Optional | ["dryness", "redness", "irritation", "sensitivity"] |
| usingAcneProducts | String | Yes | "Yes", "No" |
| currentProducts | String[] | If usingAcneProducts="Yes" | Product names/descriptions |
| stressLevel | String | Yes | "Low", "Moderate", "High" |
| sleepHours | String | Yes | "4-6", "6-8", "8-10", "10+" |
| dairyConsumption | String | Yes | "None", "Occasional", "Regular", "High" |

**Success Response (201):**
```json
{
  "message": "Questionnaire saved successfully",
  "questionnaire_id": "507f1f77bcf86cd799439011"
}
```

**Error Responses:**

| Status | Message | Description |
|--------|---------|-------------|
| 401 | "Unauthorized: Invalid user context" | Invalid/missing token |
| 409 | "Questionnaire already submitted" | User already submitted |
| 500 | "Failed to save questionnaire" | Server error |

---

### 2. Get User Status
**Endpoint:** `GET /auth/user-status`

**Authentication:** Required (JWT Token)

**Description:** Check user's completion status for questionnaire and acne analysis.

**Headers:**
```
Authorization: Bearer <JWT_token>
```

**Success Response (200):**
```json
{
  "questionnaire_completed": true,
  "acne_analysis_completed": true,
  "both_completed": true,
  "next_step": "All steps completed - proceed to dashboard"
}
```

**Possible next_step values:**
- "Complete the health questionnaire" (if questionnaire not filled)
- "Upload acne images for analysis" (if questionnaire done, images pending)
- "All steps completed - proceed to dashboard" (both completed)

**Error Responses:**

| Status | Message | Description |
|--------|---------|-------------|
| 401 | "Unauthorized: Invalid user context" | Invalid/missing token |
| 500 | "Failed to fetch user status" | Server error |

---

## Acne Analysis Endpoints

### Upload Acne Images
**Endpoint:** `POST /auth/upload-acne`

**Authentication:** Required (JWT Token)

**Content-Type:** `multipart/form-data`

**Description:** Upload acne images for ML-based severity analysis. Analyzes multiple body areas.

**Prerequisites:**
1. User must be authenticated
2. Questionnaire must be completed first
3. Each user can upload only once

**Request Format:**
```
POST /auth/upload-acne
Content-Type: multipart/form-data
Authorization: Bearer <JWT_token>

Form Fields:
- forehead (file) - Optional
- leftCheek (file) - Optional
- rightCheek (file) - Optional
- chin (file) - Optional
- neck (file) - Optional
- back (file) - Optional
- fullFace (file) - Optional (max 1 image)

At least one image required.
Each body area supports exactly 1 image.
```

**Image Requirements:**
- Format: JPEG, PNG, WebP, GIF
- Max size: 10MB per file
- Recommended: 500x500px or larger
- Quality: Clear, well-lit images work best

**Success Response (200):**
```json
{
  "message": "Acne analysis completed",
  "userId": "USR-550e8400-e29b-41d4-a716-446655440000",
  "overallSeverity": "moderate",
  "areas": [
    {
      "area": "forehead",
      "prediction": "mild",
      "confidence": 87.5,
      "prediction_id": 1,
      "probabilities": {
        "cleanskin": 0.05,
        "mild": 0.875,
        "moderate": 0.07,
        "severe": 0.005
      },
      "image_url": "https://huggingface.co/path/to/image"
    },
    {
      "area": "leftCheek",
      "prediction": "moderate",
      "confidence": 82.3,
      "prediction_id": 2,
      "probabilities": {
        "cleanskin": 0.02,
        "mild": 0.15,
        "moderate": 0.823,
        "severe": 0.007
      },
      "image_url": "https://huggingface.co/path/to/image"
    }
  ],
  "severityBreakdown": {
    "cleanskin": 0,
    "mild": 1,
    "moderate": 1,
    "severe": 0
  }
}
```

**Severity Classifications:**
- **cleanskin:** No visible acne
- **mild:** 1-10 lesions, limited impact
- **moderate:** 11-40 lesions, noticeable but manageable
- **moderate-severe:** 41-100 lesions, requires professional care
- **severe:** 100+ lesions, requires dermatologist supervision

**Error Responses:**

| Status | Message | Description |
|--------|---------|-------------|
| 400 | "Complete questionnaire before uploading acne images" | Questionnaire missing |
| 400 | "At least one image required" | No images provided |
| 409 | "Acne analysis already completed for this user" | Already analyzed |
| 401 | "Unauthorized: Invalid user context" | Invalid/missing token |
| 400 | "Only one image allowed for {fieldname}" | Multiple images for one area |
| 502 | "ML API failed for area: {fieldname}" | ML service error |
| 502 | "Invalid ML response for area: {fieldname}" | Malformed ML response |
| 500 | "Image processing failed" | Server error |

---

## Treatment Plan Endpoints

### 1. Generate Day 1 Treatment Plan
**Endpoint:** `POST /treatment/start`

**Authentication:** Required (JWT Token)

**Description:** Generate initial treatment plan based on questionnaire and acne analysis.

**Prerequisites:**
1. Questionnaire must be completed
2. Acne images must be analyzed
3. Treatment plan can only be generated once per user

**Request Body:** Empty (uses user data from database)

**Headers:**
```
Authorization: Bearer <JWT_token>
Content-Type: application/json
```

**Success Response (200):**
```json
{
  "message": "Day 1 treatment generated",
  "day": 1,
  "overallSeverity": "moderate",
  "plan": {
    "morning": "Salicylic acid wash, Clindamycin 1% gel, oil-free moisturizer, SPF sunscreen",
    "afternoon": "Avoid sun exposure, blotting if needed",
    "evening": "Azelaic acid 15% or Adapalene 0.1%, light moisturizer",
    "motivation": "Your personalized treatment starts today. Consistency is key!"
  }
}
```

**Treatment Plan Details:**

The response includes **3 daily sessions**:

| Session | Best Time | Purpose |
|---------|-----------|---------|
| morning | 6-9 AM | Cleanse, medicate, protect |
| afternoon | 12-3 PM | Maintenance, sun protection |
| evening | 7-10 PM | Deep cleanse, night treatment |

**Severity-Based Plans:**
- **cleanskin:** Maintenance routine only
- **mild:** Salicylic acid, mild retinoids
- **moderate:** Clindamycin + Adapalene
- **moderate-severe:** Benzoyl peroxide + oral antibiotics (doctor supervised)
- **severe:** âš ï¸ Dermatologist supervision mandatory

**Does NOT include:**
- Isotretinoin (Accutane)
- Hormonal contraceptives without medical consultation
- Antibiotic monotherapy (always combined)

**Error Responses:**

| Status | Message | Description |
|--------|---------|-------------|
| 401 | "Unauthorized" | Invalid/missing token |
| 400 | "Complete questionnaire first" | Questionnaire missing |
| 400 | "Complete acne analysis first" | Images not analyzed |
| 409 | "Treatment plan already started" | Plan exists for user |
| 502 | "AI service unavailable. Try again." | GROQ API failure |
| 500 | "Failed to generate treatment plan" | Server error |

---

### 2. Submit Day Review
**Endpoint:** `POST /treatment/review`

**Authentication:** Required (JWT Token)

**Description:** Submit feedback for current day and generate next day's plan.

**Request Body:**
```json
{
  "day": 1,
  "feedback": "positive",
  "notes": "Skin feels less oily, minor redness in afternoon"
}
```

**Field Details:**

| Field | Type | Required | Values |
|-------|------|----------|--------|
| day | Integer | Yes | 1, 2, 3, ... (current day only) |
| feedback | String | Yes | "positive" or "negative" |
| notes | String | No | User observations, max 500 chars |

**Feedback Meanings:**
- **positive:** Treatment working well, continue similar approach
- **negative:** Treatment caused issues, switch to gentler alternatives

**Success Response (200):**
```json
{
  "message": "Day 1 reviewed. Day 2 plan generated",
  "day": 2,
  "plan": {
    "morning": "Gentle face wash, Salicylic acid 0.5-2%, oil-free paraben-free moisturizer, SPF sunscreen",
    "afternoon": "Blotting if oily, avoid touching face",
    "evening": "Gentle cleanser, Azelaic acid 10-15%, light moisturizer",
    "motivation": "Great progress! Your skin is adapting well to the treatment.",
    "adjustment_reason": "User reported good tolerance. Increased concentration slightly based on positive feedback."
  }
}
```

**Progression:**
- Day 1 â†’ 7: Initial phase, introducing treatments
- Day 7+: Long-term maintenance and adjustment
- Maximum: Users can continue indefinitely

**Error Responses:**

| Status | Message | Description |
|--------|---------|-------------|
| 401 | "Unauthorized" | Invalid/missing token |
| 400 | "day and feedback are required" | Missing fields |
| 400 | "day must be a valid positive integer" | Invalid day format |
| 400 | "feedback must be 'positive' or 'negative'" | Invalid feedback value |
| 400 | "Cannot review Day X. Current day is Y." | Attempting to skip days |
| 404 | "No treatment plan found. Generate Day 1 first." | No plan exists |
| 409 | "Day X already reviewed" | Duplicate review attempt |
| 502 | "AI service unavailable. Try again." | GROQ API failure |
| 500 | "Failed to submit review" | Server error |

---

### 3. Get Treatment Status
**Endpoint:** `GET /treatment/status`

**Authentication:** Required (JWT Token)

**Description:** Get current treatment plan status and progress.

**Headers:**
```
Authorization: Bearer <JWT_token>
```

**Success Response (200):**
```json
{
  "message": "Treatment status retrieved",
  "currentDay": 3,
  "overallSeverity": "moderate",
  "questionnaire_completed": true,
  "acne_analysis_completed": true,
  "daysCompleted": 2,
  "daysProgram": [
    {
      "day": 1,
      "morning": {
        "treatment": "Salicylic acid wash, Clindamycin 1% gel, oil-free moisturizer, SPF sunscreen",
        "completed": true
      },
      "afternoon": {
        "treatment": "Avoid sun exposure, blotting if needed",
        "completed": true
      },
      "evening": {
        "treatment": "Azelaic acid 15%, light moisturizer",
        "completed": true
      },
      "motivation": "Your personalized treatment starts today. Consistency is key!",
      "adjustment_reason": "Initial plan based on assessment",
      "feedback": "positive",
      "userNotes": "Skin feels less oily"
    },
    {
      "day": 2,
      "morning": {
        "treatment": "Gentle face wash, Salicylic acid 0.5-2%, oil-free moisturizer, SPF sunscreen",
        "completed": true
      },
      "afternoon": {
        "treatment": "Blotting if oily, avoid touching face",
        "completed": true
      },
      "evening": {
        "treatment": "Gentle cleanser, Azelaic acid 10-15%, light moisturizer",
        "completed": true
      },
      "motivation": "Great progress! Your skin is adapting well.",
      "adjustment_reason": "User reported good tolerance.",
      "feedback": "positive",
      "userNotes": "Clear improvement with cheeks"
    },
    {
      "day": 3,
      "morning": {
        "treatment": "Gentle face wash, Salicylic acid 0.5-2%, oil-free moisturizer, SPF sunscreen",
        "completed": false
      },
      "afternoon": {
        "treatment": "Blotting if oily, avoid touching face",
        "completed": false
      },
      "evening": {
        "treatment": "Gentle cleanser, Azelaic acid 10-15%, light moisturizer",
        "completed": false
      },
      "motivation": "You're doing great! Keep up the momentum.",
      "adjustment_reason": "Continuing positive trajectory",
      "feedback": null,
      "userNotes": null
    }
  ]
}
```

**Error Responses:**

| Status | Message | Description |
|--------|---------|-------------|
| 401 | "Unauthorized" | Invalid/missing token |
| 404 | "No treatment plan found" | User hasn't started treatment |
| 500 | "Failed to fetch treatment status" | Server error |

---

## Request/Response Format

### Standard Request Headers
```
Content-Type: application/json
Authorization: Bearer <JWT_token>  [For protected routes only]
```

### Standard Response Structure

**Success (2xx):**
```json
{
  "message": "Action completed",
  "data": { ... }
}
```

**Error (4xx, 5xx):**
```json
{
  "message": "Error description",
  "error": "Detailed error message (only in development mode)"
}
```

### Timestamp Format
- ISO 8601: `2024-02-27T10:30:00Z`
- UTC timezone

---

## Error Codes

| Code | Name | Description |
|------|------|-------------|
| 400 | Bad Request | Invalid request body, missing fields, validation failed |
| 401 | Unauthorized | Missing or invalid JWT token |
| 403 | Forbidden | Account not verified, insufficient permissions |
| 404 | Not Found | Resource doesn't exist |
| 409 | Conflict | Resource already exists (duplicate registration, double submission) |
| 429 | Too Many Requests | Rate limit exceeded |
| 500 | Internal Server Error | Unexpected server error |
| 502 | Bad Gateway | External service (ML API, GROQ) unavailable |

---

## Authentication & Security

### JWT Token Structure
```
Header: {
  "alg": "HS256",
  "typ": "JWT"
}

Payload: {
  "userId": "USR-550e8400-e29b-41d4-a716-446655440000",
  "email": "john@example.com",
  "isVerified": true,
  "iat": 1708940400,
  "exp": 1709545200
}
```

### Token Expiry
- Expires: 7 days from issuance
- Refresh: Not supported (obtain new token via login)

### Using JWT Token
```
GET /api/auth/user-status HTTP/1.1
Host: localhost:5000
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### Security Features
âœ… Password Hashing: bcrypt (salt rounds: 12)
âœ… OTP Validation: 6-digit codes, 5-minute expiry
âœ… Email Verification: Required before login
âœ… CORS Protection: Only whitelisted origins allowed
âœ… Rate Limiting: Prevents brute force attacks
âœ… SQL/NoSQL Injection: Query parameterization
âœ… XSS Protection: Input sanitization
âœ… HTTPS: Recommended for production
âœ… Secure Cookies: HttpOnly, SameSite flags set

### Password Requirements
- Minimum 8 characters
- Should include uppercase, lowercase, numbers, special characters (recommended)
- Cannot contain username or email

### OTP Behavior
- Generated: 6 random digits (100,000 - 999,999)
- Validity: 5 minutes
- Resendable: If expired or not yet received
- Max attempts: Unlimited (rate-limited)

---

## Project Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       AcneAI User Journey                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1ï¸âƒ£ AUTHENTICATION PHASE
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   Register   â”‚ â†’ Email OTP Sent
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Verify OTP   â”‚ â†’ Account Activated
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
   â”‚    Login      â”‚ â†’ JWT Token Issued
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          
2ï¸âƒ£ ASSESSMENT PHASE
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Complete Health            â”‚
   â”‚ Questionnaire             â”‚
   â”‚ (Age, SkinType, etc.)     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Upload Acne     â”‚
        â”‚  Images (6 areas)â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ ML Analysis Result â”‚
        â”‚ (Severity Score)   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚

3ï¸âƒ£ TREATMENT PLANNING PHASE
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Generate Day 1 Plan      â”‚
   â”‚ (via GROQ AI)            â”‚
   â”‚ - Morning Treatment      â”‚
   â”‚ - Afternoon Routine      â”‚
   â”‚ - Evening Care           â”‚
   â”‚ - Motivation             â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
        â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Daily Review  â”‚
        â”‚  Positive â†”    â”‚
        â”‚  Negative â†”    â”‚
        â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ AI Generates Day 2 Plan â”‚
   â”‚ (Adaptive Adjustments)  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
        â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Continue for     â”‚
        â”‚ 7+ Days or More  â”‚
        â”‚ (Unlimited)      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

4ï¸âƒ£ DATA FLOW WITH EXTERNAL SERVICES
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚      User's React Vite App      â”‚
   â”‚  (localhost:5173)               â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚ HTTPS/CORS Allowed
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚    AcneAI Backend (Express.js)      â”‚
   â”‚    (localhost:5000)                 â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚          â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  MongoDB     â”‚   â”‚  ML API (HF)     â”‚
    â”‚  Database    â”‚   â”‚  + GROQ LLM      â”‚
    â”‚              â”‚   â”‚  + Nodemailer    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

5ï¸âƒ£ STATUS FLOW
   START â†’ Registered â†’ Verified â†’ Questionnaire â†’ Images â†’ 
   Day 1 Created â†’ Day 1 Reviewed â†’ Day 2 Created â†’ ... â†’ 
   Day N Reviewed (Continuous Treatment)
```

---

## Example Complete User Journey

### Step 1: Register
```bash
curl -X POST http://localhost:5000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "john_doe",
    "email": "john@example.com",
    "password": "SecurePass123!",
    "retype_password": "SecurePass123!"
  }'
```

### Step 2: Verify OTP
```bash
curl -X POST http://localhost:5000/api/auth/verify-otp \
  -H "Content-Type: application/json" \
  -d '{
    "email": "john@example.com",
    "otp": "123456"
  }'
```

### Step 3: Login
```bash
curl -X POST http://localhost:5000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "john@example.com",
    "password": "SecurePass123!"
  }'
```

Response contains JWT token.

### Step 4: Submit Questionnaire
```bash
curl -X POST http://localhost:5000/api/auth/userinfo \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <JWT_TOKEN>" \
  -d '{
    "ageGroup": "25-35",
    "sex": "Male",
    "skinType": "Oily",
    "acneDuration": "2-3 years",
    "acneLocation": ["forehead", "cheeks", "chin"],
    "sensitiveSkin": "No",
    "medicationAllergy": "No",
    "allergyReactionTypes": [],
    "acneMedicationReaction": [],
    "usingAcneProducts": "Yes",
    "currentProducts": ["Salicylic acid wash"],
    "stressLevel": "High",
    "sleepHours": "6-8",
    "dairyConsumption": "Regular"
  }'
```

### Step 5: Upload Acne Images
```bash
curl -X POST http://localhost:5000/api/auth/upload-acne \
  -H "Authorization: Bearer <JWT_TOKEN>" \
  -F "forehead=@forehead.jpg" \
  -F "leftCheek=@left_cheek.jpg" \
  -F "rightCheek=@right_cheek.jpg" \
  -F "chin=@chin.jpg"
```

### Step 6: Generate Treatment Plan
```bash
curl -X POST http://localhost:5000/api/treatment/start \
  -H "Authorization: Bearer <JWT_TOKEN>"
```

### Step 7: Check Daily Plan
```bash
curl -X GET http://localhost:5000/api/treatment/status \
  -H "Authorization: Bearer <JWT_TOKEN>"
```

### Step 8: Submit Daily Review
```bash
curl -X POST http://localhost:5000/api/treatment/review \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <JWT_TOKEN>" \
  -d '{
    "day": 1,
    "feedback": "positive",
    "notes": "Skin feels better, minor redness"
  }'
```

---

## Troubleshooting

### CORS Errors
**Error:** `Access to XMLHttpRequest has been blocked by CORS policy`

**Solution:** 
1. Check that your React app is running on `http://localhost:5173`
2. Verify `ALLOWED_ORIGINS` in `.env` includes your frontend URL
3. Ensure Origin header is being sent by frontend

### Token Expiry
**Error:** `401 Unauthorized - Invalid token`

**Solution:**
1. Token lasts 7 days
2. Re-login to get new token
3. Update Authorization header with new token

### ML API Failures
**Error:** `502 ML API failed for area: forehead`

**Solution:**
1. Check ML service is running
2. Verify ML_API_URL in environment
3. Try uploading different images
4. Check image quality and format

### Rate Limit Exceeded
**Error:** `429 Too Many Requests`

**Solution:**
1. Wait 15 minutes before retrying
2. Implement exponential backoff in frontend
3. Cache responses when possible

---

## Support & Feedback

For issues, feature requests, or feedback:
- GitHub Issues: [AcneDetectionBackendREST](https://github.com/VALLISRIMANI/AcneDetectionBackendREST)
- Email: support@acneai.com

---

## Version History

| Version | Date | Changes |
|---------|------|---------|
| 2.0.0 | 2024-02-27 | Complete API redesign with CORS configuration for React Vite |
| 1.0.0 | 2024-02-20 | Initial release |

---

**Last Updated:** February 27, 2024
**Maintained By:** AcneAI Development Team
**License:** ISC
